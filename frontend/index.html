<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Postos de Combustíveis</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #ff6600;
            --background-color: #f5f5f5;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        header h1 i {
            margin-right: 0.5rem;
            color: var(--secondary-color);
        }
        
        .search-container {
            display: flex;
            align-items: center;
            flex: 1;
            max-width: 500px;
            margin: 0 1rem;
        }
        
        .search-container input {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 4px 0 0 4px;
            font-size: 1rem;
        }
        
        .search-container button {
            background-color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }
        
        .search-container button:hover {
            background-color: #f0f0f0;
        }
        
        .locate-me {
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .locate-me:hover {
            background-color: #f0f0f0;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .filters {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .filters h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        .filter-group {
            margin-bottom: 1rem;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .filter-group input[type="range"] {
            margin-top: 0.5rem;
        }
        
        .apply-filters {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.2s;
        }
        
        .apply-filters:hover {
            background-color: #0055aa;
        }
        
        .postos-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .postos-list h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        .posto-card {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .posto-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .posto-card h4 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .bandeira {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .bandeira img {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
            object-fit: contain;
        }
        
        .endereco {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .precos {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .preco-tag {
            background-color: #f0f0f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        
        .preco-tag i {
            margin-right: 0.25rem;
        }
        
        .preco-tag.destaque {
            background-color: var(--primary-color);
            color: white;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .posto-details {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            padding: 1.5rem;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        
        .posto-header {
            display: flex;
            margin-bottom: 1rem;
        }
        
        .posto-logo {
            width: 50px;
            height: 50px;
            margin-right: 1rem;
            object-fit: contain;
        }
        
        .posto-title h2 {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
            color: var(--primary-color);
        }
        
        .posto-details .endereco {
            font-size: 0.9rem;
            color: #666;
        }
        
        .posto-details .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .posto-details .label {
            font-weight: bold;
            color: #666;
        }
        
        .posto-details .value {
            font-weight: bold;
        }
        
        .posto-details .value.destaque {
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .posto-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .action-button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-button i {
            margin-right: 0.5rem;
        }
        
        .action-button.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .action-button.secondary {
            background-color: #f0f0f0;
            color: #666;
        }
        
        .action-button.primary:hover {
            background-color: #0055aa;
        }
        
        .action-button.secondary:hover {
            background-color: #e0e0e0;
        }
        
        .loading-message,
        .error-message,
        .empty-message {
            padding: 2rem;
            text-align: center;
        }
        
        .loading-message i,
        .error-message i,
        .empty-message i {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .loading-message i {
            color: var(--primary-color);
        }
        
        .error-message i {
            color: var(--danger-color);
        }
        
        .empty-message i {
            color: var(--warning-color);
        }
        
        .simulado-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .simulado-warning i {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50%;
                box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            }
            
            .search-container {
                max-width: none;
            }
            
            .posto-details {
                width: 95%;
            }
        }
        
        /* Marcadores personalizados */
        .user-marker {
            color: #0066cc;
            font-size: 30px;
            text-shadow: 2px 2px 3px rgba(0,0,0,0.3);
        }
        
        .posto-marker div {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .posto-marker i {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1><i class="fas fa-gas-pump"></i> Mapa de Postos de Combustíveis</h1>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar por endereço ou cidade...">
                <button id="search-button"><i class="fas fa-search"></i></button>
            </div>
            <button id="locate-me" class="locate-me" title="Minha localização"><i class="fas fa-location-arrow"></i></button>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="filters">
                    <h2>Filtros</h2>
                    <div class="filter-group">
                        <label for="filter-combustivel">Combustível:</label>
                        <select id="filter-combustivel">
                            <option value="gasolina">Gasolina</option>
                            <option value="alcool">Álcool</option>
                            <option value="diesel">Diesel</option>
                            <option value="gnv">GNV</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-bandeira">Bandeira:</label>
                        <select id="filter-bandeira">
                            <option value="todas">Todas</option>
                            <option value="Petrobras">Petrobras</option>
                            <option value="Shell">Shell</option>
                            <option value="Ipiranga">Ipiranga</option>
                            <option value="Outras">Outras</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-raio">Raio de busca (km):</label>
                        <input type="range" id="filter-raio" min="1" max="20" value="5" step="1">
                        <div id="raio-value">5 km</div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-ordenacao">Ordenar por:</label>
                        <select id="filter-ordenacao">
                            <option value="distancia">Distância</option>
                            <option value="preco">Menor preço</option>
                        </select>
                    </div>
                    
                    <button id="apply-filters" class="apply-filters">Aplicar Filtros</button>
                </div>
                
                <div id="postos-container" class="postos-list">
                    <div class="loading-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando postos...</p>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                
                <div id="posto-details" class="posto-details">
                    <button class="close-button"><i class="fas fa-times"></i></button>
                    <div id="posto-info"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Custom JS -->
    <script>
        /**
         * API.js - Responsável pela comunicação com o backend
         */
        class API {
            constructor() {
                // URL base da API
                this.baseUrl = '/api';
            }
            
            /**
             * Busca postos próximos a uma localização
             */
            async buscarPostosProximos(params) {
                try {
                    // Construir URL com parâmetros
                    const url = new URL(`${this.baseUrl}/postos/proximos`, window.location.origin);
                    
                    // Adicionar parâmetros à URL
                    Object.keys(params).forEach(key => {
                        if (params[key] !== undefined && params[key] !== null) {
                            url.searchParams.append(key, params[key]);
                        }
                    });
                    
                    // Fazer requisição
                    const response = await fetch(url);
                    
                    // Verificar se a requisição foi bem-sucedida
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar postos: ${response.status}`);
                    }
                    
                    // Retornar dados
                    return await response.json();
                } catch (error) {
                    console.error('Erro na API:', error);
                    throw error;
                }
            }
            
            /**
             * Busca detalhes de um posto específico
             */
            async buscarPostoPorId(id) {
                try {
                    const response = await fetch(`${this.baseUrl}/postos/${id}`);
                    
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar posto: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Erro na API:', error);
                    throw error;
                }
            }
            
            /**
             * Busca lista de cidades disponíveis
             */
            async buscarCidades() {
                try {
                    const response = await fetch(`${this.baseUrl}/postos/cidades`);
                    
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar cidades: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Erro na API:', error);
                    throw error;
                }
            }
            
            /**
             * Busca lista de bandeiras disponíveis
             */
            async buscarBandeiras() {
                try {
                    const response = await fetch(`${this.baseUrl}/postos/bandeiras`);
                    
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar bandeiras: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Erro na API:', error);
                    throw error;
                }
            }
            
            /**
             * Busca status da API
             */
            async buscarStatus() {
                try {
                    const response = await fetch(`${this.baseUrl}/status`);
                    
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Erro na API:', error);
                    throw error;
                }
            }
        }
        
        /**
         * MapManager - Responsável pela inicialização e gerenciamento do mapa
         */
        class MapManager {
            constructor() {
                this.map = null;
                this.userMarker = null;
                this.markers = L.markerClusterGroup();
                this.postos = [];
                this.currentPosition = null;
                this.selectedPostoId = null;
                this.usandoDadosSimulados = false;
            }
            
            /**
             * Inicializa o mapa
             */
            init() {
                // Inicializar o mapa com o centro no Brasil
                this.map = L.map('map').setView([-15.77972, -47.92972], 5);
                
                // Adicionar camada de mapa base (OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                // Adicionar o grupo de marcadores ao mapa
                this.map.addLayer(this.markers);
                
                // Configurar eventos do mapa
                this.setupMapEvents();
                
                // Tentar obter a localização do usuário
                this.getUserLocation();
            }
            
            /**
             * Configura os eventos do mapa
             */
            setupMapEvents() {
                // Evento de clique no mapa
                this.map.on('click', () => {
                    // Fechar detalhes se estiverem abertos
                    const modal = document.getElementById('posto-details');
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                
                // Evento de zoom
                this.map.on('zoomend', () => {
                    // Atualizar marcadores se necessário
                    if (this.currentPosition && this.map.getZoom() > 12) {
                        this.loadNearbyPostos();
                    }
                });
            }
            
            /**
             * Obtém a localização do usuário
             */
            getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            this.currentPosition = { lat: latitude, lng: longitude };
                            
                            // Centralizar o mapa na posição do usuário
                            this.map.setView([latitude, longitude], 14);
                            
                            // Adicionar marcador do usuário
                            this.addUserMarker(latitude, longitude);
                            
                            // Carregar postos próximos
                            this.loadNearbyPostos();
                        },
                        (error) => {
                            console.error('Erro ao obter localização:', error);
                            // Exibir mensagem para o usuário
                            this.showLocationError();
                            
                            // Usar localização padrão (São Paulo)
                            this.currentPosition = { lat: -23.5505, lng: -46.6333 };
                            this.map.setView([-23.5505, -46.6333], 14);
                            this.addUserMarker(-23.5505, -46.6333);
                            this.loadNearbyPostos();
                        }
                    );
                } else {
                    console.error('Geolocalização não suportada pelo navegador');
                    this.showLocationError();
                    
                    // Usar localização padrão (São Paulo)
                    this.currentPosition = { lat: -23.5505, lng: -46.6333 };
                    this.map.setView([-23.5505, -46.6333], 14);
                    this.addUserMarker(-23.5505, -46.6333);
                    this.loadNearbyPostos();
                }
            }
            
            /**
             * Exibe mensagem de erro de localização
             */
            showLocationError() {
                const container = document.getElementById('postos-container');
                container.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Não foi possível obter sua localização. Por favor, utilize a busca para encontrar postos.</p>
                    </div>
                `;
            }
            
            /**
             * Adiciona marcador do usuário ao mapa
             */
            addUserMarker(lat, lng) {
                // Remover marcador anterior se existir
                if (this.userMarker) {
                    this.map.removeLayer(this.userMarker);
                }
                
                // Criar ícone personalizado para o usuário
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: '<i class="fas fa-user-circle"></i>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                // Adicionar novo marcador
                this.userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(this.map);
                this.userMarker.bindPopup('Sua localização').openPopup();
            }
            
            /**
             * Carrega postos próximos à localização atual
             */
            async loadNearbyPostos() {
                if (!this.currentPosition) return;
                
                const { lat, lng } = this.currentPosition;
                const raio = document.getElementById('filter-raio').value;
                const combustivel = document.getElementById('filter-combustivel').value;
                const bandeira = document.getElementById('filter-bandeira').value;
                const ordenacao = document.getElementById('filter-ordenacao').value;
                
                try {
                    // Mostrar indicador de carregamento
                    document.getElementById('postos-container').innerHTML = `
                        <div class="loading-message">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando postos...</p>
                        </div>
                    `;
                    
                    // Buscar postos via API
                    const api = new API();
                    const postos = await api.buscarPostosProximos({
                        lat,
                        lon: lng,
                        raio,
                        combustivel,
                        bandeira: bandeira !== 'todas' ? bandeira : null,
                        ordenar: ordenacao
                    });
                    
                    // Verificar se há postos na resposta
                    if (postos && postos.length > 0) {
                        this.postos = postos;
                        this.usandoDadosSimulados = postos.some(p => p.fonte === 'Simulado');
                        
                        // Limpar marcadores existentes
                        this.markers.clearLayers();
                        
                        // Adicionar novos marcadores
                        this.addPostosToMap(this.postos);
                        
                        // Atualizar lista de postos
                        this.updatePostosList(this.postos);
                    } else {
                        // Exibir mensagem de nenhum posto encontrado
                        document.getElementById('postos-container').innerHTML = `
                            <div class="empty-message">
                                <i class="fas fa-info-circle"></i>
                                <p>Nenhum posto encontrado nesta região.</p>
                            </div>
                        `;
                        
                        // Limpar marcadores existentes
                        this.markers.clearLayers();
                    }
                } catch (error) {
                    console.error('Erro ao carregar postos:', error);
                    
                    // Exibir mensagem de erro
                    document.getElementById('postos-container').innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Erro ao carregar postos. Por favor, tente novamente.</p>
                        </div>
                    `;
                }
            }
            
            /**
             * Adiciona postos ao mapa como marcadores
             */
            addPostosToMap(postos) {
                postos.forEach(posto => {
                    // Verificar se o posto tem coordenadas válidas
                    if (!posto.latitude || !posto.longitude) return;
                    
                    // Criar ícone personalizado baseado na bandeira
                    const icon = this.createPostoIcon(posto.bandeira);
                    
                    // Criar marcador
                    const marker = L.marker([posto.latitude, posto.longitude], { icon }).bindPopup(posto.nome);
                    
                    // Adicionar evento de clique
                    marker.on('click', () => {
                        this.showPostoDetails(posto.posto);
                    });
                    
                    // Adicionar ao grupo de marcadores
                    this.markers.addLayer(marker);
                });
            }
            
            /**
             * Cria ícone personalizado para o posto baseado na bandeira
             */
            createPostoIcon(bandeira) {
                // Cores para diferentes bandeiras
                const colors = {
                    'Petrobras': '#00A335',
                    'Shell': '#FFCC00',
                    'Ipiranga': '#0066B3',
                    'default': '#FF6600'
                };
                
                const color = colors[bandeira] || colors.default;
                
                return L.divIcon({
                    className: 'posto-marker',
                    html: `<div style="background-color: ${color}"><i class="fas fa-gas-pump"></i></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
            }
            
            /**
             * Atualiza a lista de postos na interface
             */
            updatePostosList(postos) {
                const container = document.getElementById('postos-container');
                
                if (postos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <i class="fas fa-info-circle"></i>
                            <p>Nenhum posto encontrado nesta região.</p>
                        </div>
                    `;
                    return;
                }
                
                // Filtrar combustível selecionado
                const combustivel = document.getElementById('filter-combustivel').value;
                
                // Adicionar aviso se estiver usando dados simulados
                let avisoSimulado = '';
                if (this.usandoDadosSimulados) {
                    avisoSimulado = `
                        <div class="simulado-warning">
                            <i class="fas fa-info-circle"></i>
                            <p>Exibindo dados simulados para demonstração. Em um ambiente de produção, seriam exibidos dados reais da API.</p>
                        </div>
                    `;
                }
                
                // Criar HTML para cada posto
                const postosHTML = postos.map(posto => {
                    // Obter preço do combustível selecionado
                    let preco = posto[`preco_${combustivel}`] || posto.preco_gasolina;
                    if (!preco || preco === 'N/A') preco = 'N/D';
                    
                    // Formatar distância
                    const distancia = posto.distancia ? `${posto.distancia.toFixed(1)} km` : '';
                    
                    return `
                        <div class="posto-card" data-id="${posto.posto}" onclick="mapManager.showPostoDetails(${posto.posto})">
                            <h4>${posto.nome}</h4>
                            <div class="bandeira">
                                <span>${posto.bandeira || 'Bandeira Branca'}</span>
                            </div>
                            <div class="endereco">${posto.endereco}, ${posto.bairro}</div>
                            <div class="precos">
                                <div class="preco-tag destaque">
                                    <i class="fas fa-gas-pump"></i>
                                    ${combustivel.charAt(0).toUpperCase() + combustivel.slice(1)}: R$ ${preco}
                                </div>
                                ${distancia ? `
                                <div class="preco-tag">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${distancia}
                                </div>
                                ` : ''}
                                <div class="preco-tag">
                                    <i class="fas fa-calendar-alt"></i>
                                    Atualizado: ${this.formatDate(posto.data_coleta)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = avisoSimulado + `
                    <h2>Postos Próximos</h2>
                    ${postosHTML}
                `;
            }
            
            /**
             * Formata data para exibição
             */
            formatDate(dateStr) {
                if (!dateStr) return 'N/D';
                
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            }
            
            /**
             * Exibe detalhes de um posto específico
             */
            showPostoDetails(postoId) {
                // Encontrar o posto pelo ID
                const posto = this.postos.find(p => p.posto == postoId);
                if (!posto) return;
                
                this.selectedPostoId = postoId;
                
                // Preencher modal com informações do posto
                const postoInfo = document.getElementById('posto-info');
                
                // Adicionar aviso se estiver usando dados simulados
                let avisoSimulado = '';
                if (this.usandoDadosSimulados) {
                    avisoSimulado = `
                        <div class="simulado-warning" style="margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i>
                            <p>Dados simulados para demonstração.</p>
                        </div>
                    `;
                }
                
                postoInfo.innerHTML = avisoSimulado + `
                    <div class="posto-header">
                        <div class="posto-title">
                            <h2>${posto.nome}</h2>
                            <div class="endereco">${posto.endereco}, ${posto.bairro}</div>
                        </div>
                    </div>
                    
                    <div class="posto-details">
                        <div class="detail-item">
                            <div class="label">Gasolina</div>
                            <div class="value ${posto.preco_gasolina && posto.preco_gasolina !== 'N/A' ? 'destaque' : ''}">${posto.preco_gasolina && posto.preco_gasolina !== 'N/A' ? 'R$ ' + posto.preco_gasolina : 'Não disponível'}</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="label">Álcool</div>
                            <div class="value ${posto.preco_alcool && posto.preco_alcool !== 'N/A' ? 'destaque' : ''}">${posto.preco_alcool && posto.preco_alcool !== 'N/A' ? 'R$ ' + posto.preco_alcool : 'Não disponível'}</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="label">Diesel</div>
                            <div class="value ${posto.preco_diesel && posto.preco_diesel !== 'N/A' ? 'destaque' : ''}">${posto.preco_diesel && posto.preco_diesel !== 'N/A' ? 'R$ ' + posto.preco_diesel : 'Não disponível'}</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="label">GNV</div>
                            <div class="value ${posto.preco_gnv && posto.preco_gnv !== 'N/A' ? 'destaque' : ''}">${posto.preco_gnv && posto.preco_gnv !== 'N/A' ? 'R$ ' + posto.preco_gnv : 'Não disponível'}</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="label">Bandeira</div>
                            <div class="value">${posto.bandeira || 'Bandeira Branca'}</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="label">Distância</div>
                            <div class="value">${posto.distancia ? posto.distancia.toFixed(2) + ' km' : 'N/D'}</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="label">Última Atualização</div>
                            <div class="value">${this.formatDate(posto.data_coleta)}</div>
                        </div>
                    </div>
                    
                    <div class="posto-actions">
                        <button class="action-button primary" onclick="mapManager.navigateToPosto(${posto.latitude}, ${posto.longitude})">
                            <i class="fas fa-directions"></i>
                            Como Chegar
                        </button>
                        
                        <button class="action-button secondary" onclick="document.getElementById('posto-details').style.display='none'">
                            <i class="fas fa-times"></i>
                            Fechar
                        </button>
                    </div>
                `;
                
                // Exibir modal
                document.getElementById('posto-details').style.display = 'block';
                
                // Centralizar mapa no posto
                if (posto.latitude && posto.longitude) {
                    this.map.setView([posto.latitude, posto.longitude], 16);
                }
            }
            
            /**
             * Navega até o posto (abre em app externo)
             */
            navigateToPosto(lat, lng) {
                if (!lat || !lng) return;
                
                // Abrir no Google Maps
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
            }
            
            /**
             * Busca postos por endereço
             */
            async searchByAddress(address) {
                if (!address) return;
                
                try {
                    // Geocodificar endereço usando Nominatim (OpenStreetMap)
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=br`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        
                        // Atualizar posição atual
                        this.currentPosition = { lat, lng: lon };
                        
                        // Centralizar mapa
                        this.map.setView([lat, lon], 14);
                        
                        // Adicionar marcador
                        this.addUserMarker(lat, lon);
                        
                        // Carregar postos próximos
                        this.loadNearbyPostos();
                    } else {
                        alert('Endereço não encontrado. Tente novamente com um endereço mais específico.');
                    }
                } catch (error) {
                    console.error('Erro ao buscar endereço:', error);
                    alert('Erro ao buscar endereço. Por favor, tente novamente.');
                }
            }
        }
        
        // Inicializar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM carregado, iniciando aplicação...");
            
            // Inicializar o mapa
            window.mapManager = new MapManager();
            mapManager.init();
            
            // Configurar eventos da interface
            setupEventListeners();
        });
        
        /**
         * Configura os listeners de eventos da interface
         */
        function setupEventListeners() {
            console.log("Configurando event listeners...");
            
            // Botão de busca
            const searchButton = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');
            
            searchButton.addEventListener('click', () => {
                const address = searchInput.value.trim();
                if (address) {
                    mapManager.searchByAddress(address);
                }
            });
            
            // Permitir busca ao pressionar Enter
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const address = searchInput.value.trim();
                    if (address) {
                        mapManager.searchByAddress(address);
                    }
                }
            });
            
            // Botão de localização
            const locateButton = document.getElementById('locate-me');
            locateButton.addEventListener('click', () => {
                mapManager.getUserLocation();
            });
            
            // Botão de aplicar filtros
            const applyFiltersButton = document.getElementById('apply-filters');
            applyFiltersButton.addEventListener('click', () => {
                mapManager.loadNearbyPostos();
            });
            
            // Slider de raio
            const raioSlider = document.getElementById('filter-raio');
            const raioValue = document.getElementById('raio-value');
            
            raioSlider.addEventListener('input', () => {
                raioValue.textContent = `${raioSlider.value} km`;
            });
            
            // Fechar modal ao clicar no X
            const closeButton = document.querySelector('.close-button');
            closeButton.addEventListener('click', () => {
                document.getElementById('posto-details').style.display = 'none';
            });
            
            // Fechar modal ao clicar fora
            const modal = document.getElementById('posto-details');
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            console.log("Event listeners configurados com sucesso");
        }
    </script>
</body>
</html>
